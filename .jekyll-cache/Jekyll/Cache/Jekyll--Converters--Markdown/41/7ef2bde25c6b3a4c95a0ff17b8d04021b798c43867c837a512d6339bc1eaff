I"Á<blockquote>
  <p>æœ¬æ–‡ä¸ºæ–¯å¦ç¦å¤§å­¦è®¡ç®—æœºç½‘ç»œè¯¾ç¨‹ CS144 ç¼–ç¨‹ä»»åŠ¡ Lab Assignment 2 çš„å­¦ä¹ å°ç»“</p>

  <p>å®˜ç½‘ https://cs144.github.io/</p>

  <p>Lab 2 æ–‡æ¡£ https://cs144.github.io/assignments/lab2.pdf</p>

  <p>ä¸ªäººå®éªŒå¤‡ä»½ä»£ç  https://github.com/deepzheng/sponge</p>
</blockquote>

<hr />

<p>æœ¬æ¬¡ Lab éœ€è¦å®ç° TCP çš„æ¥æ”¶ç«¯ï¼Œè´Ÿè´£æ¥æ”¶ TCP æŠ¥æ–‡ï¼Œå¹¶ç¡®å®šåº”å‘é€çš„ acknowledgment ç¡®è®¤ç¼–ç ä»¥åŠæµé‡æ§åˆ¶</p>

<h2 id="translating-between-64-bit-indexes-and-32-bit-seqnos">Translating between 64-bit indexes and 32-bit seqnos</h2>

<p>åœ¨ä¼ è¾“çš„ TCP æŠ¥æ–‡å¤´éƒ¨ä¸­ï¼Œç”±äºç©ºé—´é™åˆ¶ï¼Œå­—èŠ‚åºåˆ—å·åªèƒ½ç”¨ 32 ä½çš„ç´¢å¼•æ¥è¡¨ç¤ºã€‚ä½†æ˜¯ 32 ä½å¯èƒ½æ— æ³•å®Œå…¨ä¸€ä¸€å¯¹åº”ä¸€ä¸²å­—èŠ‚æµï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬åœ¨æ¥æ”¶ç«¯äººä¸ºå°†ç´¢å¼•è½¬æ¢ä¸º 64 ä½ä»¥ä¿è¯ä¸ä¼šæº¢å‡ºã€‚</p>

<p><img src="https://pic4.zhimg.com/80/v2-6bcc3809f841934db004b62596f14549.png" alt="" /></p>

<p>å¦‚ä¸Šå›¾ï¼Œå°è£…åœ¨ TCP header ä¸­çš„æ˜¯ seqno ï¼ŒSYN ä¸ºèµ·å§‹ä¿¡å·ï¼Œå…¶ seqno æ˜¯éšæœºçš„ï¼Œæˆ‘ä»¬æŠŠ SYN çš„ seqno ç§°ä¸º ISNã€‚</p>

<p>æœ¬éƒ¨åˆ†éœ€è¦æˆ‘ä»¬å®Œæˆä¸¤ä¸ªå‡½æ•°æ¥å®Œæˆ TCP åºåˆ—å·å’Œå­—èŠ‚æµç´¢å¼•ä¹‹é—´çš„ç›¸äº’è½¬æ¢</p>

<h3 id="wrap">wrap</h3>

<p>å°† absolute seqno è½¬æ¢ä¸º seqno</p>

<p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œç›´æ¥åŠ ä¸Šå»å°±è¡Œï¼Œéœ€è¦æ³¨æ„ç±»å‹è½¬æ¢éœ€è¦ç”¨åˆ° <code class="language-plaintext highlighter-rouge">static_cast&lt; &gt;</code></p>

<pre><code class="language-C++">WrappingInt32 wrap(uint64_t n, WrappingInt32 isn) {
    return WrappingInt32(static_cast&lt;uint32_t&gt; (n) + isn.raw_value());
}
</code></pre>

<h3 id="unwrap">unwrap</h3>

<p>å°† seqno è½¬æ¢ä¸º absolute seqno</p>

<p>ç”±äºå¾ˆå¤š 64 ä½ç´¢å¼•éƒ½å¯èƒ½è¢«åŒ…è£…æˆåŒä¸€ä¸ª 32 ä½åºåˆ—å· ï¼ˆeg ï¼šå½“ ISN ä¸º 0ï¼Œåºåˆ—å· 17 å¯èƒ½ä»£è¡¨ 17, 2<sup>32</sup> + 17, 2<sup>33</sup> + 17, 2<sup>34</sup> + 17â€¦ï¼‰æ‰€ä»¥æˆ‘ä»¬éœ€è¦ checkpoint æ¥è¾…åŠ©åˆ¤æ–­ï¼Œå®ƒçš„å€¼ä¸ºä¹‹å‰å®ç°è¿‡çš„ ByteStream ä¸­ç¬¬ä¸€ä¸ªæœªç»„è£…çš„å­—èŠ‚ç´¢å¼•å·ï¼ˆ64ä½ï¼Œä»0å¼€å§‹ï¼‰ã€‚unwarp å‡½æ•°è¿”å›çš„ç´¢å¼•å€¼ä¸ºæœ€æ¥è¿‘ checkpoint çš„å€¼</p>

<p>æ€è·¯ä¸Šï¼Œé¦–å…ˆåº”è¯¥è®¡ç®—å‡º n ä¸ å¼€å¤´ isn çš„åç§»é‡ offsetã€‚ç”±äº checkpoint å¯ä»¥è¡¨ç¤ºä¸º  mod * 2<sup>32</sup> + kï¼Œç”»ä¸ªå›¾å°±çŸ¥é“è·ç¦» checkpoint æœ€è¿‘çš„æ•°å¯èƒ½æœ‰ 3 ç§æƒ…å†µ :</p>

<ol>
  <li>mod * 2 <sup>32</sup> + offset</li>
  <li>(mod - 1) * 2 <sup>32</sup> + offset</li>
  <li>(mod + 1) * 2 <sup>32</sup> + offset
<img src="https://pic4.zhimg.com/80/v2-c93d8267a527a0fc55e5184e014eebf6.png" alt="" /></li>
</ol>

<p>è®¡ç®—å‡ºè¿™ä¸‰ä¸ªçš„å€¼ç„¶åæ¯”è¾ƒå–è·ç¦»æœ€å°çš„å³å¯</p>

<pre><code class="language-C++">uint64_t unwrap(WrappingInt32 n, WrappingInt32 isn, uint64_t checkpoint) {
    uint64_t offset = static_cast&lt;uint64_t&gt; (n.raw_value()- isn.raw_value());
    uint64_t add =  1ul &lt;&lt; 32;
    uint64_t mod = checkpoint &gt;&gt; 32;
    uint64_t offset_1 = offset + mod * add;
    //éœ€è¦ç‰¹åˆ¤ mod ä¸º 0 çš„æƒ…å†µï¼Œæ­¤æ—¶ mod-1 æ²¡æœ‰æ„ä¹‰
    uint64_t offset_2 = mod !=0 ? offset + (mod - 1) * add : offset_1; 
    uint64_t offset_3 = offset + (mod + 1) * add;
    uint64_t abs_1 = offset_1 &gt; checkpoint ? offset_1 - checkpoint : checkpoint - offset_1;
    uint64_t abs_2 = offset_2 &gt; checkpoint ? offset_2 - checkpoint : checkpoint - offset_2;
    uint64_t abs_3 = offset_3 &gt; checkpoint ? offset_3 - checkpoint : checkpoint - offset_3;

    uint64_t min_abs = min(min(abs_1,abs_2),abs_3);
    if(min_abs == abs_1)    return offset_1;
    if(min_abs == abs_2)    return offset_2;
    if(min_abs == abs_3)    return offset_3;

}
</code></pre>

<h2 id="implementing-the-tcp-receiver">Implementing the TCP receiver</h2>

<h3 id="segment_received">segment_received</h3>

<p><img src="https://pic4.zhimg.com/80/v2-df7a29961fd900005dcdc3e8173a5184.png" alt="TCPæ¥æ”¶æµç¨‹" /></p>

<ul>
  <li>TCPReceiver ä¸€å¼€å§‹å¤„äºç›‘å¬çŠ¶æ€ï¼Œä¸€æ—¦æ¥æ”¶åˆ° SYN ä¿¡å·ï¼Œå°†é¦–ä¸ªåºåˆ—å·è®¾ä¸º ISNï¼Œå¹¶å¼€å§‹è¯»å…¥æµç¨‹</li>
  <li>è®¡ç®— checkpoint å’Œç¬¬ä¸€ä¸ªæœ‰æ•ˆå­—ç¬¦çš„åºåˆ—å·ï¼Œé€šè¿‡ <code class="language-plaintext highlighter-rouge">wrap</code> è½¬æ¢ä¸ºæ‰€éœ€çš„ä»0å¼€å§‹çš„ index</li>
  <li>è°ƒç”¨ <code class="language-plaintext highlighter-rouge">push_substring</code> å°†æŠ¥æ–‡ä¸­çš„å­—ç¬¦ä¸²è¯»å…¥ Reassembler ä¸­å¼€å§‹ç»„è£…æµç¨‹</li>
</ul>

<pre><code class="language-C++">void TCPReceiver::segment_received(const TCPSegment &amp;seg) {
    TCPHeader head = seg.header();
    if(!_is_syn &amp;&amp; !head.syn)   return ;

    if(head.syn){
        _is_syn = true;
        _isn = head.seqno; 
    }
    
    string payload = seg.payload().copy();
    WrappingInt32 seqno = head.syn ? head.seqno + 1 : head.seqno; //ç¬¬ä¸€ä¸ªæœ‰æ•ˆå­—ç¬¦çš„åºåˆ—å·    
    uint64_t checkpoint = stream_out().bytes_written();
    //uwarpå‡ºæ¥æ˜¯ absolute seqno éœ€è¦ -1 æ‰èƒ½è½¬åŒ–æˆ stream index
    uint64_t index = unwrap(seqno,_isn,checkpoint) - 1;

    _reassembler.push_substring(payload, index, _is_syn &amp;&amp; head.fin);
}
</code></pre>

<h3 id="ackno">ackno</h3>

<p>è¿”å›ç¬¬ä¸€ä¸ªæœªç¡®è®¤æ¥æ”¶çš„å­—èŠ‚åºåˆ—å·ï¼Œè¿”å›æ—¶å…ˆè¿›è¡Œ warp æ“ä½œè½¬åŒ–ä¸º 32ä½åºåˆ—å·ã€‚</p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ¥æ”¶çš„æŠ¥æ–‡æ®µä¸­å«æœ‰ FIN ä¿¡å·ï¼Œåˆ™éœ€è¦å°†åŸæœ¬çš„åºåˆ—å·å†åŠ  1ï¼ˆå› ä¸º FIN åœ¨å‘é€å’Œæ¥æ”¶æ—¶éƒ½å æ®äº†ä¸€ä¸ªåºåˆ—å·ï¼Œä½†æ˜¯å´å¹¶æ²¡æœ‰è¯»å…¥ï¼Œ<code class="language-plaintext highlighter-rouge">bytes_written()</code>ä¸­æ²¡æœ‰è®¡ç®—è¿™ä¸ªå­—èŠ‚ï¼‰</p>

<pre><code class="language-C++">optional&lt;WrappingInt32&gt; TCPReceiver::ackno() const { 
    if(!_is_syn)    return {};
    else{
        size_t ack = stream_out().bytes_written() + 1;
        if(stream_out().input_ended())   return wrap(ack + 1,_isn); 
        else    return wrap(ack,_isn); 
    }
}
</code></pre>

<h3 id="window_size">window_size</h3>

<p>è¿”å› <code class="language-plaintext highlighter-rouge">first unassembled</code> åˆ° <code class="language-plaintext highlighter-rouge">first unacceptable</code> çš„è·ç¦»ï¼Œç”±äº TCPReceiver å’Œ ByteStream å…±äº«å®¹é‡ï¼Œåœ¨ ByteStream ä¸­å·²ç»å®ç°äº† <code class="language-plaintext highlighter-rouge">remaining_capacity()</code> åŠŸèƒ½ï¼Œç›´æ¥è°ƒç”¨å³å¯</p>

<pre><code class="language-C++">size_t TCPReceiver::window_size() const { 
  return stream_out().remaining_capacity();
}
</code></pre>

<p><img src="https://pic4.zhimg.com/80/v2-3d3bb386b10e6cac2ce96704af8848bc.png" alt="æµ‹è¯•é€šè¿‡" /></p>

<h2 id="å°ç»“">å°ç»“</h2>

<p>æœ¬èŠ‚ Lab è™½ç„¶ä»£ç é‡ä¸æ˜¯å¾ˆå¤§ï¼Œä½†æ˜¯è¦åšå‡ºæ¥è¿˜æ˜¯éœ€è¦å¯¹æ–‡æ¡£å†…å®¹å’Œè¦æ±‚ç†è§£é€å½»å¹¶ä¸”ç†Ÿæ‚‰ä¹‹å‰æ‰€å®Œæˆè¿‡çš„å†…å®¹ï¼Œé‡ç‚¹æ˜¯é‚£ä¸‰ä¸ªåºåˆ—å·çš„ç›¸äº’ä¹‹é—´çš„å…³ç³»ï¼å¦åˆ™å°±ä¼šå‡ºç°è¿™é‡Œå¿˜è®° +1 é‚£é‡Œå¿˜è®° -1 çš„å°é”™è¯¯</p>

<p>åŒæ—¶ï¼Œé€šè¿‡å®Œæˆè¿™æ¬¡ä»»åŠ¡ä¹Ÿè§£å¼€äº†æˆ‘ Lab1 ä¸­çš„å°ç–‘é—®ï¼šä¸ºä»€ä¹ˆ <code class="language-plaintext highlighter-rouge">push_substring</code> ä¸­èµ·å§‹çš„ index ä¸€å®šæ˜¯ä» 0 å¼€å§‹çš„ï¼Ÿä¸æ˜¯è¯´èµ·å§‹çš„åºåˆ—å·æ˜¯ä»ä¸€ä¸ªéšæœºçš„å·ç å¼€å§‹çš„å—ï¼Ÿ åŸæ¥è¿˜æ˜¯æˆ‘å¯¹ TCP æ¥æ”¶å¤„ç†çš„ç»†èŠ‚ç†è§£ä¸å¤Ÿã€‚ TCP ä¼ è¾“æŠ¥æ–‡æ®µä¸­çš„èµ·å§‹åºåˆ—å·ç¡®å®æ˜¯éšæœºçš„ 32 ä½ç¼–ç ï¼Œä½†æ˜¯å½“ä¼ è¾“åˆ°æ¥æ”¶ç«¯æ—¶ï¼ŒTCP åˆä¼šå¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œè½¬æ¢ä¸º 64 ä½å¹¶ä¸”ä» 0 å¼€å§‹çš„ç´¢å¼•ï¼Œæ–¹ä¾¿ç»„è£…æ“ä½œï¼Œå¹¶ä¸”ç¡®ä¿å°½å¯èƒ½ä¸ä¼šå‡ºç°ç¼–ç æº¢å‡ºæƒ…å†µ</p>
:ET